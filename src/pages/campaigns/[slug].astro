---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { campaigns } from '../../campaigns';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  return campaigns.map((c) => ({
    params: { slug: c.id },
    props: { campaign: c },
  }));
}

const { campaign } = Astro.props;

// Load & sort this campaign's recaps (newest first)
let recaps = await getCollection('recaps', (e) => e.data.campaignId === campaign.id);
recaps = recaps.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const isAcroterra = campaign.id === 'acroterra';
const pdfSrc = '/acroterra.pdf';
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={campaign.title} description={campaign.blurb} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#0b0f1a; --ink:#fff; --edge:rgba(255,255,255,.15); --panel: rgba(0,0,0,.5); }
      html,body { height:100% }
      body { margin:0; color:var(--ink); font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
             background:#0b0f1a url('/Mountains.png') center/cover fixed no-repeat; }
      main { width:min(1200px,94%); margin:24px auto; }

      .hero { margin-bottom:32px; }
      .hero img { display:block; margin:0 auto; width:100%; max-width:1000px; height:auto; border-radius:16px; object-fit:contain; background:#000; }
      .title { margin:12px 0 6px; font-size:clamp(24px,3.6vw,40px); color:#fff; text-align:center; }
      .sub { opacity:.9; margin:0 0 20px; text-align:center; }

      .toolbar{ display:flex; flex-wrap:wrap; gap:20px; align-items:center; justify-content:center; margin:0 auto; padding-top:8px; }
      .cta-btn{ display:inline-flex; align-items:center; gap:8px; padding:16px 32px; font-size:1.15rem; font-weight:600; color:#fff;
                background:#5b2b82; border:none; border-radius:12px; text-decoration:none; box-shadow:0 6px 16px rgba(0,0,0,.35);
                transition: background-color .2s, transform .15s, box-shadow .2s; }
      .cta-btn:hover{ background:#7d42aa; transform:translateY(-2px);
        box-shadow: 0 0 12px rgba(123,63,184,.6), 0 10px 22px rgba(0,0,0,.45);
        animation: pulse-glow 1.2s ease-in-out infinite alternate;
      }
      @keyframes pulse-glow {
        from { box-shadow: 0 0 10px rgba(123,63,184,.6), 0 10px 22px rgba(0,0,0,.45); }
        to   { box-shadow: 0 0 22px rgba(123,63,184,.6), 0 12px 28px rgba(0,0,0,.5);  }
      }

      /* Recaps layout */
      .recaps { width:min(1000px, 100%); margin: 24px auto 40px; display: grid; gap: 16px; }
      .recap {
        background: var(--panel);
        border: 1px solid var(--edge);
        border-radius: 14px;
        padding: 16px 18px;
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0,0,0,.35);
      }
      .recap-header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
      .recap-title { margin:0; color:#fff; font-size:1.1rem; font-weight:700; }
      .recap-date { margin:0; color:#fff; opacity:.8; font-size:.95rem; }
      .recap-body :is(p, ul, ol){ margin: 10px 0; color:#fff; }
      .recap-body ul{ padding-left: 1.2rem; }
      .recap-body strong { color:#fff; }
      .empty { text-align:center; opacity:.85; padding:18px; }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <section class="hero">
        <img src={campaign.image} alt={`${campaign.title} banner`} />
        <h1 class="title">{campaign.title}</h1>
        <p class="sub">{campaign.schedule}</p>

        <div class="toolbar">
          {isAcroterra && (
            <a class="cta-btn" href={pdfSrc} download>ðŸŽ² Download Kevin's Guide to Acroterra PDF ðŸŽ²</a>
          )}
          <a class="cta-btn" href="https://play.questwithwasem.com" target="_blank" rel="noopener">ðŸŽ² Go to Virtual Table Top ðŸŽ²</a>
        </div>
      </section>

      <!-- Session Recaps -->
      <section class="recaps" aria-labelledby="recaps-heading">
        <h2 id="recaps-heading" class="title" style="font-size: clamp(20px,2.4vw,28px); margin-bottom: 4px;">Session Recaps</h2>

        {recaps.length === 0 ? (
          <div class="recap empty">No recaps yet. Check back after the next session!</div>
        ) : (
          recaps.map(({ id, data, body }) => (
            <article class="recap" id={id}>
              <header class="recap-header">
                <h3 class="recap-title">{data.title}</h3>
                <p class="recap-date">
                  {new Date(data.date).toLocaleDateString('en-US', { weekday:'short', year:'numeric', month:'short', day:'numeric' })}
                </p>
              </header>
              <div class="recap-body">
                {/** Render Markdown body */}
                <Fragment set:html={body} />
              </div>
            </article>
          ))
        )}
      </section>

      <section>
        <p>{campaign.blurb}</p>
      </section>
    </main>
    <Footer />
  </body>
</html>
